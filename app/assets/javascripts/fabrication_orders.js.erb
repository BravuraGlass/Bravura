var BRAVURA = BRAVURA || {};

BRAVURA.showRooms = function showRooms(){
  $('#roomsPanel').toggleClass('hide');
};

BRAVURA.showCreateEditProductModal = function showCreateEditProductModal(){
  $('#createEditProductModal').modal({
      show: true,
      keyboard: false
  });
};

BRAVURA.toggleProductSections = function toggleProductSections(element, id){
  // switching the expand/collapse option
  if($(element).hasClass('fa-plus')){
    $(element).removeClass('fa-plus').addClass('fa-minus');
  } else {
    $(element).removeClass('fa-minus').addClass('fa-plus');
  }
  $('#productsList').find("tr[data-parent='"+id+"']").toggleClass('hide');
};

BRAVURA.closeCreateEditProductModal = function closeCreateEditProductModal() {
  $('#createEditRoomModal').modal('hide');
};

BRAVURA.saveCreateEditProductModal = function saveStatusChange(){
  // do the save
  var product = {
    room_id: $("#product_room_id").val(),
    fabrication_order_id: $("#fabrication_order_id").val(),
    room_name: $("#product_room_name").val(),
    product_type_id: $("#product_product_type_id").val(),
    name: $("#product_name").val(),
    sections: $("#product_sections").val()
  };
  var fabrication_order_id = $('#fabrication_order_id').val();
  $.ajax({
    method: "POST",
    url: "/fabrication_orders/"+fabrication_order_id+"/products.json",
    data: { "product": product },
    dataType: "json"
  })
  .done(function(data){
    $('#createEditRoomModal').modal('hide');
    location.href =  "/fabrication_orders/"+fabrication_order_id+"/edit?new_product_id="+data.id;
  })
  .fail(function(response){
    alert('There was an error saving the product');
  });

};

// set the behavior on document ready
$(document).ready(function(){
  $('#createEditRoomModalCancelButton').on('click', function() { BRAVURA.closeCreateEditProductModal(); });
  $('#createEditProductModalSaveButton').on('click', function() { BRAVURA.saveCreateEditProductModal(); });
  $('#newProductButton').on('click', function() { BRAVURA.showCreateEditProductModal(); });
  $('.edit-product-button').on('click', function() { BRAVURA.showCreateSectionModal(); });
  
  $('.cloneMasterButton').on('click', function() {
    $('#cloneMasterModal').modal({
        show: true,
        keyboard: false
    });
  });  
  
  $('.cloneMasterButton').on('click', function() {
    $('#cloneMasterModal').modal({
        show: true,
        keyboard: false
    });
  });  
  
  $('#masterModalCloneButton').on('click', function() {
    var mroom_id = $('#master_room_id').val();
    var forder_id = $('#master_fabrication_order_id').val();
    var next_room = $('#master_next_room').val();

    $.ajax({
      method: "POST",
      url: "/fabrication_orders/"+forder_id+"/rooms/clone",
      data: {id: mroom_id, next_room: next_room},
      dataType: "script"
    });
  });  
  
  $('.master-room').on('click', function() {
    var theid = $(this).attr("id").split("-")[1]
    
    if($(this).is(':checked')){
      $('.cb-room-'+theid).prop('checked', true); 
    } else {
      $('.cb-room-'+theid).prop('checked', false);
    }  
  });   
  
  $('.master-product').on('click', function() {
    var theid = $(this).attr("id").split("-")[1]
    
    if($(this).is(':checked')){
      $('.cb-product-'+theid).prop('checked', true); 
    } else {
      $('.cb-product-'+theid).prop('checked', false);
    }  
  });  
  
  $('#cb_product_all').on('click', function() {
    
    if($(this).is(':checked')){
      $('.master-room').prop('checked', true); 
      $('.master-product').prop('checked', true); 
      $('.master-section').prop('checked', true); 
    } else {
      $('.master-room').prop('checked', false); 
      $('.master-product').prop('checked', false); 
      $('.master-section').prop('checked', false); 
    }  
  });  
  
  
  $('.printProduct').on('click', function() {
    var ids = []
    $('.master-section').each(function() {
      if($(this).is(':checked')) {
        ids.push($(this).attr("id").split("-")[1])
      } 
    });
    
    $('input#ids').val(ids)
    
    $("#form_prints_product").submit();
  });  
  
  $(".product-status-select").focus(function () {
    $(this).data('was', this.value)
  });

  $('.product-status-select').on('ajax:success', function(data, status, xhr){
    var product_id = $(this).attr("id").split("product-status-")[1];
    var room_id = $(this).attr("class").split("product-status-parent-room-")[1];
    if ($(this).val() == 'FINISHED') {
    
      var section_id
      $('.section-status-parent-product-'+product_id).each(function(i,el) {
        section_id = $(el).attr('id');
        $("#"+section_id+" option[value='FINISHED']").prop('selected',true);
      })

      var same_status = true
      
      $('.product-status-parent-room-'+room_id).each(function(i,el) {
        if ($(el).val() != 'FINISHED') {
          same_status = false
        }
      })  
  
      if (same_status == true) {
        $("#room-status-"+room_id+" option[value='FINISHED']").prop('selected',true);
      }

    }

    if ($(this).val() == 'Pending') {
      $("#room-status-"+room_id+" option[value='Active']").prop('selected',true);
    }

    $(this).data('was', $(this).val());

  }).on('ajax:error',function(e, xhr, status, error){
    alert("failed");
  });
    

  $(".section-status-select").focus(function () {
    $(this).data('was', this.value)
  });

  $('.section-status-select').on('ajax:success', function(data, status, xhr){
    var section_id = $(this).attr("id").split("section-status-")[1];
    var product_id_temp = $(this).attr("class").split("section-status-parent-product-")[1];
    var product_id = product_id_temp.split(" ")[0];
    var room_id = $(this).attr("class").split("section-status-parent-room-")[1];
    
    if ($(this).val() == 'FINISHED') {
      var same_status = true
      
      $('.section-status-parent-product-'+product_id).each(function(i,el) {
        if ($(el).val() != 'FINISHED') {
          same_status = false
        }
      })  
  
      if (same_status == true) {
        $("#product-status-"+product_id+" option[value='FINISHED']").prop('selected',true);
      }

      var same_status2 = true
      
      $('.section-status-parent-room-'+room_id).each(function(i,el) {
        if ($(el).val() != 'FINISHED') {
          same_status2 = false
        }
      })  
  
      if (same_status2 == true) {
        $("#room-status-"+room_id+" option[value='FINISHED']").prop('selected',true);
      } 
    }

    if($(this).data('was') == 'FINISHED' && $(this).val() != 'FINISHED'){
      $("#product-status-"+product_id+" option[value='Pending']").prop('selected',true);
      $("#room-status-"+room_id+" option[value='Active']").prop('selected',true);
    }

    $(this).data('was', $(this).val())

  }).on('ajax:error',function(e, xhr, status, error){
    alert("failed");
  });

  $(".room-status-select").focus(function () {
    $(this).data('was', this.value)
  });

  $('.room-status-select').on('ajax:success', function(data, status, xhr){
    var room_id = $(this).attr("id").split("room-status-")[1];
    if ($(this).val() == 'FINISHED') {
    
      var product_id
      $('.product-status-parent-room-'+room_id).each(function(i,el) {
        product_id = $(el).attr('id');
        $("#"+product_id+" option[value='FINISHED']").prop('selected',true);        
      })
      var section_id
      $('.section-status-parent-room-'+room_id).each(function(i,el) {
        section_id = $(el).attr('id');
        $("#"+section_id+" option[value='FINISHED']").prop('selected',true);
      })
    }
    
    if ($(this).val() == 'LOCKED') {
      $('.product-status-parent-room-'+room_id).each(function(i,el) {
        product_id = $(el).attr('id');
        $("#"+product_id).prop('disabled', true);        
      })
      
      $('.section-status-parent-room-'+room_id).each(function(i,el) {
        section_id = $(el).attr('id');
        $("#"+section_id).prop('disabled',true);
      })      
    } else {
      $('.product-status-parent-room-'+room_id).each(function(i,el) {
        product_id = $(el).attr('id');
        $("#"+product_id).prop('disabled', false);        
      })
      
      $('.section-status-parent-room-'+room_id).each(function(i,el) {
        section_id = $(el).attr('id');
        $("#"+section_id).prop('disabled', false);
      })       
    }
    if ($(this).val() == 'Not Active') {
      var product_id
      $('.product-status-parent-room-'+room_id).each(function(i,el) {
        product_id = $(el).attr('id');
        $("#"+product_id+" option[value='N/A']").prop('selected',true);        
      })
      var section_id
      $('.section-status-parent-room-'+room_id).each(function(i,el) {
        section_id = $(el).attr('id');
        $("#"+section_id+" option[value='N/A']").prop('selected',true);
      })
    }

    if($(this).val() == 'Active' && $(this).data('was') == 'Not Active'){
      var product_id
      $('.product-status-parent-room-'+room_id).each(function(i,el) {
        product_id = $(el).attr('id');
        $("#"+product_id+" option[value='Measured']").prop('selected',true);        
      })
      var section_id
      $('.section-status-parent-room-'+room_id).each(function(i,el) {
        section_id = $(el).attr('id');
        $("#"+section_id+" option[value='In Fabrication']").prop('selected',true);
      })
    }

    $(this).data('was', $(this).val())

  }).on('ajax:error',function(e, xhr, status, error){
    alert("failed");
  });
  
});
